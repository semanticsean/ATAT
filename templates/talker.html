<!--templates/dashboard.html-->
<!doctype html>
<html lang="en" class="h-full">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <style></style>
  </head>
  <body class="bg-gray-100 min-h-screen flex flex-col">
    {% include 'header.html' %}

    <div class="container mx-auto px-4 py-8">
      <h1 class="text-2xl font-bold mb-4">Talk to {{ agent.id }}</h1>
      <div class="flex">
        <div class="w-1/3">
          <img
            src="{{ url_for('serve_agent_image', filename=agent.photo_path.split('/')[-1]) }}"
            alt="{{ agent.id }}"
            class="mb-4"
          />
        </div>
        <div class="w-2/3 pl-8">
          <div id="conversation" class="mb-4">
            <!-- Conversation will be displayed here -->
          </div>
          <button
            id="record-button"
            class="bg-blue-500 text-white px-4 py-2 rounded"
          >
            Record
          </button>
          <div id="status" class="mt-4"></div>
          <audio id="response-audio" controls style="display: none"></audio>
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
      $(document).ready(function () {
        const recordButton = $("#record-button");
        const statusDiv = $("#status");
        const conversationDiv = $("#conversation");
        const responseAudio = $("#response-audio");
        let mediaRecorder;

        recordButton.on("click", startRecording);

        function startRecording() {
          navigator.mediaDevices
            .getUserMedia({ audio: true })
            .then(function (stream) {
              mediaRecorder = new MediaRecorder(stream);
              mediaRecorder.start();

              const audioChunks = [];
              mediaRecorder.addEventListener("dataavailable", function (event) {
                audioChunks.push(event.data);
              });

              mediaRecorder.addEventListener("stop", function () {
                const audioBlob = new Blob(audioChunks);
                sendAudioForTranscription(audioBlob);
              });

              recordButton.text("Stop");
              recordButton.off("click");
              recordButton.on("click", stopRecording);
            });
        }

        function stopRecording() {
          mediaRecorder.stop();
          recordButton.text("Record");
          recordButton.off("click");
          recordButton.on("click", startRecording);
        }

        function sendAudioForTranscription(audioBlob) {
          const formData = new FormData();
          formData.append("audio", audioBlob, "audio.mp3");
          formData.append("agent_id", "{{ agent.id }}");

          $.ajax({
            url: "/transcribe",
            type: "POST",
            data: formData,
            processData: false,
            contentType: false,
            success: function (response) {
              displayConversation(response.user_text, response.ai_text);
              textToSpeech(response.ai_text);
            },
            error: function (jqXHR, textStatus, errorThrown) {
              console.error("Error:", textStatus, errorThrown);
              statusDiv.text("Error: " + textStatus);
            },
          });
        }

        function displayConversation(userText, aiText) {
          conversationDiv.append(
            "<p><strong>You:</strong> " + userText + "</p>",
          );
          conversationDiv.append("<p><strong>AI:</strong> " + aiText + "</p>");
        }

        function textToSpeech(text) {
          $.ajax({
            url: "/text-to-speech",
            type: "POST",
            data: { text: text },
            success: function (response) {
              responseAudio.attr("src", response.audio_url);
              responseAudio[0].play();
            },
            error: function (jqXHR, textStatus, errorThrown) {
              console.error("Error:", textStatus, errorThrown);
              statusDiv.text("Error: " + textStatus);
            },
          });
        }
      });
    </script>
    
  </body>
</html>
