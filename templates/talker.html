<!doctype html>
<html>
  <head>
    <title>Semantic Life - Talker</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .phone-container {
        max-width: 400px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f2f2f2;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .message-bubble {
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 10px;
      }
      .user-message {
        background-color: #007bff;
        color: white;
        align-self: flex-end;
      }
      .ai-message {
        background-color: #e6e6e6;
        color: black;
        align-self: flex-start;
      }
    </style>
  </head>
  <body class="bg-gray-100">
    <div class="phone-container">
      <h1 class="text-2xl font-bold mb-4 text-center">{{ agent_id }}</h1>
      <h2 class="text-xl font-bold mb-2 text-center">{{ agent_jobtitle }}</h2>
      <p class="text-center mb-4">{{ agent_summary }}</p>
      <div id="conversation" class="mb-4 flex flex-col">
        <!-- Conversation will be displayed here -->
      </div>
      <div class="flex justify-center">
        <button
          id="record-button"
          class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-4 px-8 rounded-full"
        >
          Tap to Talk
        </button>
      </div>
      <div id="status" class="mt-4 text-center text-gray-600"></div>
      <audio id="response-audio" style="display: none"></audio>
    </div>
    <script>
      $(document).ready(function () {
        const recordButton = $("#record-button");
        const statusDiv = $("#status");
        const conversationDiv = $("#conversation");
        const responseAudio = $("#response-audio");

        let mediaRecorder;
        let isRecording = false;

        recordButton.on("click", toggleRecording);

        function toggleRecording() {
          if (!isRecording) {
            startRecording();
          } else {
            stopRecording();
          }
        }

        function startRecording() {
          isRecording = true;
          recordButton.text("Stop");
          statusDiv.text("Recording...");
          navigator.mediaDevices
            .getUserMedia({ audio: true })
            .then(function (stream) {
              mediaRecorder = new MediaRecorder(stream);
              mediaRecorder.start();
              mediaRecorder.ondataavailable = function (e) {
                handleDataAvailable(e.data);
              };
            });
        }

        function stopRecording() {
          isRecording = false;
          recordButton.text("Processing...");
          statusDiv.text("Processing...");
          mediaRecorder.stop();
        }

        function handleDataAvailable(audioBlob) {
          const formData = new FormData();
          formData.append("audio", audioBlob, "audio.wav");
          formData.append("agent_id", "{{ agent_id }}");

          $.ajax({
            url: "/transcribe",
            type: "POST",
            data: formData,
            processData: false,
            contentType: false,
            success: function (response) {
              if (response.error) {
                console.error("Transcription error:", response.error);
                statusDiv.text("Error: " + response.error);
                recordButton.text("Tap to Talk");
              } else {
                displayConversation(response.user_text, "You");

                $.ajax({
                  url: "/text-to-speech",
                  type: "POST",
                  data: { text: response.ai_text },
                  success: function (data) {
                    responseAudio.attr("src", "");  // Clear the previous source
                    responseAudio.attr("src", data.audio_url);
                    responseAudio[0].play();
                    displayConversation(response.ai_text, "AI");
                    recordButton.text("Tap to Talk");
                    statusDiv.text("Ready");
                  },
                  error: function (jqXHR, textStatus, errorThrown) {
                    console.error(
                      "Text-to-speech error:",
                      textStatus,
                      errorThrown
                    );
                    statusDiv.text("Error: " + textStatus);
                    recordButton.text("Tap to Talk");
                  },
                });
              }
            },
            error: function (jqXHR, textStatus, errorThrown) {
              console.error("Transcription error:", textStatus, errorThrown);
              statusDiv.text("Error: " + textStatus);
              recordButton.text("Tap to Talk");
            },
          });
        }

        function displayConversation(text, speaker) {
          conversationDiv.append(
            `<div class="message-bubble ${speaker.toLowerCase()}-message">${text}</div>`
          );
        }
      });
    </script>
  </body>
</html>