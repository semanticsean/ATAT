<!--templates/new_timeframe.html-->
<!doctype html>
<html lang="en" class="h-full">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Create New Timeframe</title>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.0.4/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
      }

      #content {
        min-height: 100%;
        margin-bottom: -4rem;
      }

      #footer-push {
        height: 4rem;
      }

      footer {
        height: 4rem;
      }

      .agent-item {
        display: none; /* Add this line */
        cursor: pointer;
      }

      .agent-item.selected {
        background-color: #d3e1ff;
      }

      .agent-item:hover {
        background-color: #e9f0ff;
      }

      .agent-item.selected {
        background-color: #d3e1ff;
      }

      .agent-item:hover {
        background-color: #e9f0ff;
      }

      #loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: white;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }
    </style>
  </head>
  <body class="bg-blue-50 h-full">
    {% include 'header.html' %}
    <main class="flex-grow">
      <div class="container mx-auto px-4 py-8 mt-12">
        <div class="mx-auto bg-white rounded-lg overflow-hidden md:max-w-4xl">
          <div class="flex flex-col md:flex-row">
            <div class="w-full p-4 md:p-8">
              <div class="text-center mb-8">
                <h1 class="font-bold text-3xl md:text-4xl">
                  Create New Timeframe
                </h1>
                <h3 class="text-xl md:text-2xl mt-2">1-3 minutes per synth.</h3>
                <h4 class="text-lg md:text-xl mt-1">
                  15 credits per synth adapted.
                </h4>
                <br />
                <div class="text-gray-400 text-sm">
                  Important: don't refresh the page.
                </div>
              </div>

               <form action="{{ url_for('auth_blueprint.create_timeframe') }}" method="post">
                <div class="mb-6">
                  <label for="name" class="block text-xl md:text-2xl font-bold mb-2"
                    >Name this Timeframe:</label
                  >
                  <input
                    type="text"
                    id="name"
                    name="name"
                    class="mt-1 block w-full py-3 px-4 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-base md:text-lg"
                  />
                </div>
                <div class="mb-6">
                  <label
                    for="instruction1"
                    class="block text-base font-bold text-gray-700 mb-2"
                    >Describe the timepoint, including year:</label
                  >
                  <textarea
                    id="instruction1"
                    name="instruction1"
                    rows="4"
                    class="mt-1 block w-full py-3 px-4 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-base md:text-lg"
                    required
                  ></textarea>
                </div>
                <div class="mb-6">
                  <label
                    for="instruction2"
                    class="block text-base font-bold text-gray-700 mb-2"
                    >Describe the setting, including place:</label
                  >
                  <textarea
                    id="instruction2"
                    name="instruction2"
                    rows="4"
                    class="mt-1 block w-full py-3 px-4 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-base md:text-lg"
                  ></textarea>
                </div>
                <div class="mb-8">
                  <label
                    for="instruction3"
                    class="block text-base font-bold text-gray-700 mb-2"
                    >Describe the 'plot' and other context:</label
                  >
                  <textarea
                    id="instruction3"
                    name="instruction3"
                    rows="4"
                    class="mt-1 block w-full py-3 px-4 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-base md:text-lg"
                  ></textarea>
                </div>

                <div class="mb-8">
                  <h2 class="text-2xl md:text-3xl font-bold mb-4">Select Synths:</h2>
                  <div class="mb-4">
                    <input type="text" id="search" placeholder="Search agents..." class="w-full py-2 px-4 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                  </div>
                  <div class="mb-4">
                    <select id="sort" class="w-full py-2 px-4 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                      <option value="">Sort by...</option>
                      <option value="name">Name</option>
                      <option value="timeframe">Timeframe</option>
                    </select>
                  </div>
                  <div id="agent-list" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- User Agents -->
                    <h3 class="text-xl font-bold mt-4 col-span-full">User Agents</h3>
                    {% for agent in user_agents %}
                    <div class="agent-item flex items-center mb-2 bg-white shadow-md rounded-lg px-6 py-4" data-agent-id="{{ agent.id }}" data-agent-name="{{ agent.id }}" data-agent-timeframe="">
                      <input type="checkbox" id="agent-{{ agent.id }}" name="selected_agents" value="{{ agent.id }}" class="hidden" />
                      <img src="" alt="Agent Profile" class="agent-image float-right w-12 h-12 md:w-24 md:h-24 rounded-full -ml-2 mr-4" data-src="{{ url_for('serve_image', filename=agent.photo_path.split('/')[-1] if agent.get('photo_path') else 'default.png') }}" />
                      <label for="agent-{{ agent.id }}" class="text-gray-700 text-sm md:text-base">
                        <div class="text-lg md:text-xl font-bold mb-1">{{ agent.id }}</div>
                        <div class="mb-1">{{ agent.jobtitle }}</div>
                        <div class="mb-1">{{ agent.summary }}</div>
                      </label>
                    </div>
                    {% endfor %}

                    <!-- Agent Class Agents -->
                    <h3 class="text-xl font-bold mt-4 col-span-full">Agent Class Agents</h3>
                    {% for agent in agent_class_agents %}
                    <div class="agent-item flex items-center mb-2 bg-white shadow-md rounded-lg px-6 py-4" data-agent-id="{{ agent.id }}" data-agent-name="{{ agent.id }}" data-agent-timeframe="">
                      <input type="checkbox" id="agent-{{ agent.id }}" name="selected_agents" value="{{ agent.id }}" class="hidden" />
                      <img src="" alt="Agent Profile" class="agent-image float-right w-12 h-12 md:w-24 md:h-24 rounded-full -ml-2 mr-4" data-src="{{ url_for('serve_image', filename=agent.data.photo_path.split('/')[-1]) }}" />
                      <label for="agent-{{ agent.id }}" class="text-gray-700 text-sm md:text-base">
                        <div class="text-lg md:text-xl font-bold mb-1">{{ agent.id }}</div>
                        <div class="mb-1">{{ agent.data.jobtitle }}</div>
                        <div class="mb-1">{{ agent.data.summary }}</div>
                      </label>
                    </div>
                    {% endfor %}

                    <!-- Timeframe Agents -->
                    {% for timeframe in timeframes %}
                    {% for agent in timeframe.agents_data | from_json %}
                    <div class="agent-item flex items-center mb-2 bg-white shadow-md rounded-lg px-6 py-4" data-agent-id="{{ agent.id }}" data-agent-name="{{ agent.id }}" data-agent-timeframe="{{ timeframe.name }}">
                      <input type="checkbox" id="agent-{{ agent.id }}" name="selected_agents" value="{{ agent.id }}" class="hidden" />
                      <img src="" alt="Agent Profile" class="agent-image float-right w-12 h-12 md:w-24 md:h-24 rounded-full -ml-2 mr-4" data-src="{{ url_for('serve_image', filename=agent.photo_path.split('/')[-1] if agent.get('photo_path') else 'default.png') }}" />
                      <label for="agent-{{ agent.id }}" class="text-gray-700 text-sm md:text-base">
                        <div class="text-lg md:text-xl font-bold mb-1">{{ agent.id }}</div>
                        <div class="mb-1">{{ agent.jobtitle }}</div>
                        <div class="mb-1">{{ timeframe.name }}</div>
                        <div class="mb-1">{{ agent.summary }}</div>
                      </label>
                    </div>
                    {% endfor %}
                    {% endfor %}
                  </div>
                </div>

                <button type="submit" class="px-6 py-4 md:px-8 md:py-5 bg-black text-white rounded-lg hover:bg-blue-600 w-full text-lg md:text-xl font-bold">
                  Render Timeframe
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </main>
    <div id="footer-push"></div>
    {% include 'footer.html' %}

    <div id="loading-overlay" style="display: none;">
      <img src="{{ url_for('static', filename='loading.gif') }}" class="w-48" alt="Loading" />
      <div id="agent-progress" class="text-xl mt-4"></div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const agentImages = document.querySelectorAll(".agent-image");

        agentImages.forEach((img) => {
          const src = img.getAttribute("data-src");
          img.onload = () => {
            img.closest('.agent-item').style.display = 'flex'; // Show agent item if image loads
          };
          img.onerror = () => {
            console.error("Failed to load image for agent:", img.closest('.agent-item').dataset.agentId);
          };
          img.setAttribute("src", src);
        });

        const form = document.querySelector("form");
        const loadingOverlay = document.getElementById("loading-overlay");
        const agentProgress = document.getElementById("agent-progress");
        const agentItems = document.querySelectorAll(".agent-item");
        const checkboxes = document.querySelectorAll('input[type="checkbox"]');
        const searchInput = document.getElementById("search");
        const sortSelect = document.getElementById("sort");

        // Check if the user has insufficient credits
        {% if current_user.credits is none or current_user.credits <= 0 %}
          alert("You don't have enough credits to create a new timeframe. Please top up your credits to continue.");
          window.location.href = "{{ url_for('auth_blueprint.update_profile') }}";
        {% endif %}

        // Search and filter agents
        function filterAgents() {
          const searchTerm = searchInput.value.toLowerCase();
          const sortBy = sortSelect.value;

          agentItems.forEach((item) => {
            const agentName = item.dataset.agentName.toLowerCase();
            const agentTimeframe = item.dataset.agentTimeframe.toLowerCase();
            const matchesSearch = searchTerm === "" || agentName.includes(searchTerm) || agentTimeframe.includes(searchTerm);

            if (matchesSearch) {
              item.style.display = "flex";
            } else {
              item.style.display = "none";
            }
          });

          if (sortBy === "name") {
            sortAgentsByName();
          } else if (sortBy === "timeframe") {
            sortAgentsByTimeframe();
          }
        }

        // Sort agents by name
        function sortAgentsByName() {
          const agentList = document.getElementById("agent-list");
          const agents = Array.from(agentItems);

          agents.sort((a, b) => {
            const nameA = a.dataset.agentName.toLowerCase();
            const nameB = b.dataset.agentName.toLowerCase();
            return nameA.localeCompare(nameB);
          });

          agents.forEach((agent) => agentList.appendChild(agent));
        }

        // Sort agents by timeframe
        function sortAgentsByTimeframe() {
          const agentList = document.getElementById("agent-list");
          const agents = Array.from(agentItems);

          agents.sort((a, b) => {
            const timeframeA = a.dataset.agentTimeframe.toLowerCase();
            const timeframeB = b.dataset.agentTimeframe.toLowerCase();
            return timeframeA.localeCompare(timeframeB);
          });

          agents.forEach((agent) => agentList.appendChild(agent));
        }

        // Event listeners for search and sort
        searchInput.addEventListener("input", filterAgents);
        sortSelect.addEventListener("change", filterAgents);

        // Modify the form submit event
        form.addEventListener("submit", function (e) {
          e.preventDefault(); // Prevent the default form submission

          // Show the loading overlay
          loadingOverlay.style.display = "flex";

          const formData = new FormData(form);
          const payload = {};
          for (let [key, value] of formData.entries()) {
            if (payload.hasOwnProperty(key)) {
              if (!Array.isArray(payload[key])) {
                payload[key] = [payload[key]];
              }
              payload[key].push(value);
            } else {
              payload[key] = value;
            }
          }

          console.log("Form payload to be sent to process_agents via create_timeframe:",payload);

          // Show the loading GIF when the form is being submitted
          if (loadingOnSubmit) {
            loadingOnSubmit.style.display = "block";
          }

          form.submit(); // Now submit the form programmatically
        });

        // Your existing code for handling agent item clicks
        agentItems.forEach((item) => {
          item.addEventListener("click", function (e) {
            // Prevent form from submitting if the form is clicked
            e.preventDefault();

            // Check the clicked element is not the checkbox itself
            if (e.target !== this.querySelector('input[type="checkbox"]')) {
              const checkbox = this.querySelector('input[type="checkbox"]');
              checkbox.checked = !checkbox.checked;
              this.classList.toggle("selected", checkbox.checked);
            }
          });
        });
      });
    </script>
  </body>
</html>
