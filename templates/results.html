<!--results.html -->
<!DOCTYPE html>
<html lang="en" class="h-full">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Survey Results</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.0.4/dist/tailwind.min.css">
  <style>
      canvas {
          width: 100% !important;
          height: auto !important;
          max-height: 400px; 
      }

      html, body {
        height: 100%;
        margin: 0;
      }

      #content {
        min-height: 100%;
        /* Equal to footer height */
        margin-bottom: -4rem; 
      }

      #footer-push {
        height: 4rem; 
        /* Equal to footer height */
      }

      footer {
        height: 4rem;
        /* Other styling */

      :target {
        scroll-margin-top: 200px; /* Adjust this value as needed */
      }

      /* Apply a border-box model to everything to ensure padding and borders are included in total width and height */
      *, *:before, *:after {
        box-sizing: border-box;
      }

      /* Ensure the table container has a defined width and overflow set */
      .table-responsive {
        width: 100%; /* Ensures the container fits its parent's width */
        overflow-x: auto; /* Enables horizontal scrolling */
        -webkit-overflow-scrolling: touch; /* Smooth scrolling on touch devices */
      }

      /* Style the table to ensure it's not wider than it's container */
      .table-responsive table {
        width: 100%; /* Make the table take up the container width */
        min-width: 600px; /* Adjust as needed */
        border-collapse: collapse; /* Ensures borders are collapsed into a single border */
      }

      /* Style the table cells for better legibility */
      .table-responsive th,
      .table-responsive td {
        white-space: nowrap; /* Prevent text from wrapping */
        padding: 0.5rem; /* Add some padding for spacing */
      }

      /* Apply responsive padding on very small screens */
      @media screen and (max-width: 640px) {
        .table-responsive th,
        .table-responsive td {
          padding: 0.2rem; /* Reduce padding on small screens */
        }
      }

      }

  </style>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.31.3/js/jquery.tablesorter.min.js"></script>
    <script>
                  function loadResults() {
                  console.log("Loading results...");
                  $.get("{{ url_for('survey_blueprint.get_results', survey_id=survey.id) }}", function(data) {
                      console.log("Received data:", data);
                      if (data.length > 0) {
                          var resultsContainer = $('#results-container');
                          resultsContainer.empty();

                          data.forEach(function(agent) {
                              var agentHtml = `
                                  <div class="bg-white shadow-xl rounded-lg mb-8 sm:max-w-full lg:max-w-1/2">
  <div class="flex flex-col md:flex-row items-center bg-gradient-to-r from-gray-200 to-gray-250 rounded-t-lg px-6 py-4">
    <img src="${agent.photo_path}" alt="Agent Profile" class="w-24 h-24 md:w-64 md:h-64 rounded-full border-4 border-white mb-4 md:mb-0 md:mr-12">
    <div class="text-center md:text-left">
      <h3 class="text-2xl font-bold text-black mb-4">Synth: ${agent.id || 'Unknown'}</h3>
      <div class="max-w-xl break-words"><p class="text-black font-md md:font-xl mb-4">${agent.summary}</p></div>
      <!-- Email button -->
            <button onclick="window.location.href='mailto:` + agent.email + `'" class="bg-gray-500 hover:bg-blue-500 text-white py-2 px-4 rounded">` + agent.email + `</button>
            
    </div>
  </div>
</div>

  <div class="px-6 py-4">
    <h3 class="text-2xl font-bold text-black mb-4">Responses</h3>
    <div class="bg-gray-300 rounded-lg p-4">
      ${agent.responses ? Object.entries(agent.responses).map(function([questionId, answer]) {
        var questionText = agent.questions && agent.questions[questionId] ? agent.questions[questionId].text : 'Unknown';
        return `
          <div class="mb-6">
  <div class="flex bg-white rounded-lg p-4 shadow-md">
    <!-- Container to control the max width of the bubbles -->
    <div class="mx-auto px-4 sm:px-6 lg:px-8 w-full md:w-1/2">
      <!-- Bubble container with defined max width -->
      <div class="mx-auto">
        <!-- Question Bubble -->
        <div class="w-full bg-gray-100 rounded-lg rounded-br-none shadow mb-4 p-4 md:-ml-12">
          <h4 class="text-lg md:text-2xl font-bold text-gray-400 mb-2">You</h4>
          <div class="text-lg md:text-xl text-gray-700 italic">Question / Talking Point: ${questionId}</div>
          <p class="text-gray-700 md:text-xl text-lg">${questionText}</p>
        </div>

        <!-- Answer Bubble -->
        
<div class="w-full bg-gray-200 rounded-lg rounded-bl-none shadow mb-4 p-4 -mr-12 text-right justify-right float-right">
  <div class="mb-2">
    <img src="${agent.photo_path}" alt="Agent Profile" class="md:w-12 md:h-12 h-8 w-8 rounded-full mr-2 float-right">
    <h4 class="text-xl md:text-2xl font-bold text-gray-900 mr-6 mt-1 pr-12">${agent.id}</h4>
  </div>
  <p class="text-lg md:text-xl font-bold text-gray-900 mt-8">${extractValue(answer)}</p>
</div>
      </div>
    </div>
  </div>
</div>
        `;
      }).join('') : '<p class="text-gray-700">No responses available</p>'}
    </div>
  </div>
</div>
                              `;
                              resultsContainer.append(agentHtml);
                          });

                    // Add table header
                    var tableHtml = `
                        <div class="bg-white p-6 rounded-lg shadow my-6" id="raw-data"> 
                        <div class="table-responsive">
                        <div class="block md:hidden p-4 text-center text-gray-600 bg-gray-100 rounded-lg">
                        <h2 class="text-2xl text-black font-bold mb-6">Raw Data</h2>
                          <p>The full table is available on wider screens.</p>
                          <button id="download-csv" class="mt-6 px-6 py-3 bg-blue-500 text-white font-bold rounded-lg hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-700 focus:ring-opacity-50 mb-4">Download CSV</button>
                        </div>
                        <div class="hidden md:block bg-white p-6 rounded-lg shadow my-6" id="raw-data">
                        <h2 class="text-2xl text-black font-bold mb-6">Raw Data</h2>
                        <table class="table-auto w-full sortable">
                            <thead>
                            <button id="download-csv" class="mt-6 px-6 py-3 bg-blue-500 text-white font-bold rounded-lg hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-700 focus:ring-opacity-50 float-right -mt-14 mb-6">Download CSV</button>
                                <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                                    <th class="py-3 px-6 text-left cursor-pointer">Agent ID</th>
                                    <th class="py-3 px-6 text-left cursor-pointer">Agent Email</th>
                                    <th class="py-3 px-6 text-left cursor-pointer">Question ID</th>
                                    <th class="py-3 px-6 text-left cursor-pointer">Question Text</th>
                                    <th class="py-3 px-6 text-left cursor-pointer">Answer</th>
                                </tr>
                            </thead>
                            <tbody class="text-gray-600 text-sm font-light">
                    `;

                    data.forEach(function(agent) {
                        Object.entries(agent.responses).forEach(function([questionId, answer]) {
                            var questionText = agent.questions && agent.questions[questionId] ? agent.questions[questionId].text : 'Unknown';
                            // Add row to table
                            tableHtml += `
                                <tr class="border-b border-gray-200 hover:bg-gray-100">
                                    <td class="py-3 px-6 text-left whitespace-nowrap">${agent.id}</td>
                                    <td class="py-3 px-6 text-left">${agent.email}</td>
                                    <td class="py-3 px-6 text-left">${questionId}</td>
                                    <td class="py-3 px-6 text-left">${questionText}</td>
                                    <td class="py-3 px-6 text-left">${answer}</td>
                                </tr>
                            `;
                        });
                    });

                    // Close table tag
                    tableHtml += '</tbody></table></div></div>';
                    // Append table to results container
                    resultsContainer.append(tableHtml);

                    // Call function to create chart
                    createChart(data);
                }
            });
        }

      

        // Function to create a chart
        // Function to create a chart
function createChart(data) {
    var questionCounts = {};
    data.forEach(function(agent) {
        Object.entries(agent.responses).forEach(function([questionId, answer]) {
            if (!questionCounts[questionId]) {
                questionCounts[questionId] = {};
            }
            if (!questionCounts[questionId][answer]) {
                questionCounts[questionId][answer] = 0;
            }
            questionCounts[questionId][answer]++;
        });
    });

    var ctx = document.getElementById('chart').getContext('2d');

    // Define an array of colors
    var colors = ['rgba(255, 99, 132, 0.2)', 'rgba(54, 162, 235, 0.2)', 'rgba(255, 206, 86, 0.2)', 'rgba(75, 192, 192, 0.2)', 'rgba(153, 102, 255, 0.2)', 'rgba(255, 159, 64, 0.2)'];

    var myChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [{
                label: 'Response Count',
                data: [],
                backgroundColor: [], // Dynamic colors
                borderColor: [], // Dynamic border colors
                borderWidth: 1
            }]
        },
        options: {
            plugins: {
                datalabels: {
                    align: 'end',
                    anchor: 'end'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });

    var questionDropdown = $('#question-dropdown');
    questionDropdown.empty();
    Object.keys(questionCounts).forEach(function(questionId) {
        questionDropdown.append($('<option>', {
            value: questionId,
            text: 'Question / Talking Point' + questionId
        }));
    });

    function updateChart() {
        var selectedQuestion = questionDropdown.val();
        var answerCounts = questionCounts[selectedQuestion];
        myChart.data.labels = Object.keys(answerCounts);
        myChart.data.datasets[0].data = Object.values(answerCounts);

        // Assign a color to each answer
        myChart.data.datasets[0].backgroundColor = Object.keys(answerCounts).map((_, index) => colors[index % colors.length]);
        myChart.data.datasets[0].borderColor = Object.keys(answerCounts).map((_, index) => colors[index % colors.length].replace('0.2', '1')); // Make border color slightly darker

        myChart.update();
    }

    questionDropdown.on('change', updateChart);
    updateChart();
}


        $(document).ready(function() {
            loadResults();
            $(".sortable").tablesorter();
        });


      
      data.forEach(function(agent) {
          var agentHtml = `
              <!-- other HTML content -->

              <!-- Corrected Email button using JavaScript concatenation -->
              <button onclick="window.location.href='mailto:` + agent.email + `'" class="bg-gray-500 hover:bg-blue-500 text-white py-2 px-4 rounded">` + agent.email + `</button>

              <!-- Corrected Copy Email button -->
              <button id="copyEmail` + agent.id + `" class="inline-block bg-gray-500 hover:bg-blue-500 text-white text-sm py-2 px-4 rounded" data-original-text="Copy Email Address" onclick="copyToClipboard('` + agent.email + `', 'copyEmail` + agent.id + `')" style="flex: 1 1 30%;">Copy Email</button>

              <!-- other HTML content -->
          `;
          resultsContainer.append(agentHtml);
      });

      
    </script>
    <style>
        .sortable th {
            cursor: pointer;
            user-select: none;
        }
    </style>
</head>
          <body class="bg-gray-100">
            {% include 'header.html' %}
            <div class="container mx-auto py-8">
              <h1 class="text-3xl font-bold mb-4">Survey Results</h1>
              <div class="bg-white shadow-md rounded-lg overflow-hidden">
                <div class="px-4 py-5 sm:p-6">
                  <h2 class="text-xl font-semibold mb-4">{{ survey.name }}</h2>
                  <div class="mb-4">
                    <label for="is_public" class="inline-flex items-center">
                      <input type="checkbox" id="is_public" name="is_public" {% if survey.is_public %}checked{% endif %}>
                      <span class="ml-2">Make survey results public</span>
                    </label>
                  </div>
                  {% for agent_data in results %}
                  <div class="mb-8">
                    <h3 class="text-lg font-semibold mb-2">{{ agent_data.id }}</h3>
                    <img src="{{ url_for('serve_image', filename=agent_data.photo_path) }}" alt="Agent Photo" class="w-32 h-32 rounded-full mb-4">
                    <ul>
                      {% for question_id, response in agent_data.responses.items() %}
                      <li class="mb-2">
                        <strong>{{ agent_data.questions[question_id].text }}:</strong> {{ response }}
                      </li>
                      {% endfor %}
                    </ul>
                  </div>
                  {% endfor %}
                </div>
              </div>
            </div>
            {% include 'footer.html' %}
          

    <script>
        document.getElementById('download-csv').addEventListener('click', function() {
            function escapeCSVField(field) {
                if (field == null || field == undefined) {
                    return '';
                }
                // Convert the field to a string (in case it's a number or a boolean), escape quotes, and wrap in quotes.
                return '"' + field.toString().replace(/"/g, '""') + '"';
            }

            var csvContent = 'data:text/csv;charset=utf-8,';
            csvContent += 'Agent ID,Agent Email,Question ID,Question Text,Answer\n';

            var results = {{ results|tojson }};
            results.forEach(function(agent) {
                if (agent.responses) {
                    Object.entries(agent.responses).forEach(function([questionId, answer]) {
                        var questionText = agent.questions && agent.questions[questionId] ? agent.questions[questionId].text : 'Unknown';
                        var row = [
                            escapeCSVField(agent.id),
                            escapeCSVField(agent.email),
                            escapeCSVField(questionId),
                            escapeCSVField(questionText),
                            escapeCSVField(answer)
                        ].join(',');
                        csvContent += row + '\n';
                    });
                }
            });

            var encodedUri = encodeURI(csvContent);
            var link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            link.setAttribute('download', 'survey_results.csv');
            document.body.appendChild(link);
            link.click();
        });
    </script>

          <script>
          function copyPublicUrl() {
            var publicUrlElement = document.getElementById('public-url');
            var tempInput = document.createElement('input');
            tempInput.value = publicUrlElement.href;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
            alert('Public URL copied to clipboard!');
          }

            function extractValue(answer) {
              // Regular expression to match JSON-like string
              const jsonRegex = /\{[\s]*["']?(\w+)["']?[\s]*:[\s]*["']?([^"']+)["']?[\s]*\}/;

              const match = answer.match(jsonRegex);
              if (match && match[2]) {
                return match[2]; // Return the captured value
              }

              return answer; // Return the original answer if no match found
            }
            
          </script>

</body>
</html>