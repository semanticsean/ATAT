<!-- templates/results.html -->
<!doctype html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Meeting Results</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.0.4/dist/tailwind.min.css"/>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
      canvas {
        width: 100% !important;
        height: auto !important;
        max-height: 400px;
      }
      html,
      body {
        height: 100%;
        margin: 0;
      }
      #content {
        min-height: 100%;
        margin-bottom: -4rem;
      }
      #footer-push {
        height: 4rem;
      }
      footer {
        height: 4rem;
      }
      :target {
        scroll-margin-top: 200px;
      }
      *,
      *:before,
      *:after {
        box-sizing: border-box;
      }
      .table-responsive {
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      .table-responsive table {
        width: 100%;
        min-width: 600px;
        border-collapse: collapse;
      }
      .table-responsive th,
      .table-responsive td {
        white-space: nowrap;
        padding: 0.5rem;
      }
      @media screen and (max-width: 640px) {
        .table-responsive th,
        .table-responsive td {
          padding: 0.2rem;
        }
      }

      .question {
        font-size: 1.2rem;
        font-weight: 600;
        color: #4a5568;
        margin-bottom: 0.5rem;
      }
      .answer {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1a202c;
      }
    .public-badge {
          background-color: #fbbf24;
          color: #1f2937;
          font-weight: bold;
          padding: 0.5rem 1rem;
          border-radius: 0.25rem;
        }
      </style>
    </head>
    <body class="bg-gray-100">
    {% include 'header.html' %}
    <div class="container mx-auto py-8 mt-28 px-4 md:mt-12">
      <h1 class="text-3xl font-bold mb-4">{{ meeting.name }}</h1>
      <div class="bg-white shadow-md rounded-lg overflow-hidden">
          <div class="px-4 py-5 sm:p-6">
            <form action="{{ url_for('meeting_blueprint.meeting_results', meeting_id=meeting.id) }}" method="post">
              <div class="mb-4 flex items-center">
                <label for="is_public" class="inline-flex items-center mr-4">
                  <input type="checkbox" id="is_public" name="is_public" class="hidden" {% if meeting.is_public %}checked{% endif %} onchange="this.form.submit()"/>
                  <span class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded cursor-pointer">
                    {% if meeting.is_public %}Unpublish Public Meeting{% else %}Make Meeting Public{% endif %}
                  </span>
                </label>
                {% if meeting.is_public %}
                <span class="public-badge">PUBLIC MEETING</span>
                {% endif %}
              </div>
            </form>
            {% if meeting.is_public %}
            <div id="public-url-section" class="mb-4">
              <label for="public-url" class="block text-sm font-medium text-gray-700 mb-1">Public URL:</label>
              <div class="mt-1 flex rounded-md shadow-sm">
                <input type="text" name="public-url" id="public-url" class="flex-1 min-w-0 block w-full px-3 py-2 rounded-l-md focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm border-gray-300" value="{{ request.host_url }}public/meeting/{{ meeting.public_url }}" readonly/>
                <button type="button" class="ml-2 px-4 py-2 border border-transparent text-sm font-medium rounded-r-md text-white bg-black hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" onclick="copyPublicUrl(this)">Copy</button>
                <button type="button" class="ml-2 px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-gray-700 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500" onclick="openPublicUrl()">Open</button>
              </div>
            </div>
            {% endif %}
          </div>
        </div>
      {% for agent in meeting.agents %}
      <div class="bg-white shadow-xl rounded-lg mb-8">
        <div class="bg-gradient-to-r from-gray-200 to-gray-250 px-6 py-4 md:flex">
          <div class="md:w-1/4 lg:w-1/5 flex justify-center md:justify-start">
            <img src="{{ custom_image_filter(agent.photo_path, '64x64') }}" alt="Agent Profile" class="w-16 h-16 md:w-32 md:h-32 lg:w-48 lg:h-48 rounded-full border-4 border-white"/>
          </div>
          <div class="md:w-3/4 lg:w-4/5 mt-4 md:mt-0">
            <div class="text-center md:text-left">
              <h3 class="text-2xl font-bold text-black">{{ agent.id }}</h3>
              <p class="text-xl font-semibold text-gray-700">{{ agent.jobtitle }}</p>
              <p class="text-lg text-gray-700">{{ agent.persona[:142] + '...' }}</p>
              <p class="text-gray-600">Keywords: {{ agent.keywords|join(', ') }}</p>
            </div>
            <div class="bg-gray-100 mt-4 md:mt-6 p-4 rounded-lg">
              <h3 class="text-xl font-bold text-black mb-2">Responses:</h3>
              {% if meeting.answers[agent.id] %}
              {% for question_id, answer in meeting.answers[agent.id].items() %}
              <div class="mb-4">
                {% if meeting.questions and meeting.questions[question_id] %}
                <p class="question font-bold">{{ meeting.questions[question_id]['text'] }}</p>
                {% else %}
                <p class="question font-bold">Question {{ question_id }}</p>
                {% endif %}
                <div class="answer text-lg">{{ answer|safe }}</div>
              </div>
              {% endfor %}
              {% else %}
              <p class="text-gray-600">No responses available for this agent.</p>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      {% endfor %}


      </div>
    </div>
    {% include 'footer.html' %}

    <script>
      function copyPublicUrl(button) {
        var publicUrlInput = document.getElementById("public-url");
        publicUrlInput.select();
        document.execCommand("copy");
        button.innerText = "Copied!";
        setTimeout(function() {
          button.innerText = "Copy";
        }, 2000);
      }

      function openPublicUrl() {
        var publicUrl = document.getElementById("public-url").value;
        window.open(publicUrl, "_blank");
      }

      function togglePublicUrl() {
        var isPublicCheckbox = document.getElementById("is_public");
        var publicUrlSection = document.getElementById("public-url-section");
        if (isPublicCheckbox && publicUrlSection) {
          if (isPublicCheckbox.checked) {
            publicUrlSection.style.display = "block";
          } else {
            publicUrlSection.style.display = "none";
          }
        }
      }

      $(document).ready(function () {
        var isPublicCheckbox = document.getElementById("is_public");
        if (isPublicCheckbox) {
          togglePublicUrl();

          $("#is_public").on("change", function () {
            var isPublic = $(this).is(":checked");
            console.log("Public meeting checkbox state changed:", isPublic);

            $.ajax({
              url: '{{ url_for("meeting_blueprint.meeting_results", meeting_id=meeting.id) }}',
              method: "POST",
              data: { is_public: isPublic },
              dataType: 'json',  // Specify the expected response data type
              success: function (response) {
                console.log("AJAX request success:", response);
                if (response.success) {
                  $("#public-url").val(response.public_url);
                  togglePublicUrl();
                } else {
                  console.error("Error updating public URL:", response.error);
                }
              },
              error: function (xhr, status, error) {
                console.error("AJAX request error:", error);
              },
            });
          });
        }
      });
    </script>
    </body>
    </html>